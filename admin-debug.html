<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <title>EXPRESSGLASS ‚Ä¢ Admin Debug</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f7fa;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 10px;
      padding: 30px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }

    h1 {
      color: #667eea;
      margin-bottom: 30px;
      text-align: center;
    }

    .debug-section {
      margin-bottom: 30px;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #f8f9fa;
    }

    .debug-section h2 {
      color: #333;
      margin-bottom: 15px;
      font-size: 18px;
    }

    .status {
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      font-weight: 500;
    }

    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .status.loading {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
      font-size: 14px;
    }

    .btn:hover {
      background: #5a6fd8;
    }

    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    pre {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      overflow-x: auto;
      font-size: 12px;
      border: 1px solid #ddd;
      max-height: 300px;
      overflow-y: auto;
    }

    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 20px;
    }

    @media (max-width: 768px) {
      .info-grid {
        grid-template-columns: 1fr;
      }
    }

    .test-result {
      padding: 10px;
      margin: 5px 0;
      border-radius: 5px;
      font-family: monospace;
      font-size: 12px;
    }

    .test-result.pass {
      background: #d4edda;
      color: #155724;
    }

    .test-result.fail {
      background: #f8d7da;
      color: #721c24;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîß EXPRESSGLASS - Debug do Painel Admin</h1>
    
    <div class="debug-section">
      <h2>üîç Informa√ß√µes do Sistema</h2>
      <div id="systemInfo" class="status loading">Carregando informa√ß√µes...</div>
      <button class="btn" onclick="checkSystemInfo()">Verificar Sistema</button>
    </div>

    <div class="debug-section">
      <h2>üîë Teste de Autentica√ß√£o</h2>
      <div id="authInfo" class="status loading">Aguardando teste...</div>
      <button class="btn" onclick="testAuthentication()">Testar Auth</button>
    </div>

    <div class="debug-section">
      <h2>üåê Teste das Fun√ß√µes Netlify</h2>
      <div id="functionsInfo" class="status loading">Aguardando teste...</div>
      <button class="btn" onclick="testNetlifyFunctions()">Testar Fun√ß√µes</button>
    </div>

    <div class="debug-section">
      <h2>üë• Teste Admin Users</h2>
      <div id="adminUsersInfo" class="status loading">Aguardando teste...</div>
      <button class="btn" onclick="testAdminUsers()">Testar Admin Users</button>
    </div>

    <div class="debug-section">
      <h2>üìä Logs Detalhados</h2>
      <pre id="detailedLogs">Logs aparecer√£o aqui...</pre>
      <button class="btn" onclick="clearLogs()">Limpar Logs</button>
    </div>
  </div>

  <script>
    let logs = [];
    
    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = `[${timestamp}] [${type.toUpperCase()}] ${message}`;
      logs.push(logEntry);
      
      document.getElementById('detailedLogs').textContent = logs.join('\n');
      console.log(logEntry);
      
      // Auto-scroll para o final
      const logsElement = document.getElementById('detailedLogs');
      logsElement.scrollTop = logsElement.scrollHeight;
    }

    function clearLogs() {
      logs = [];
      document.getElementById('detailedLogs').textContent = 'Logs limpos...';
    }

    function updateStatus(elementId, message, type) {
      const element = document.getElementById(elementId);
      element.textContent = message;
      element.className = `status ${type}`;
    }

    function checkSystemInfo() {
      log('Verificando informa√ß√µes do sistema...');
      
      const info = {
        userAgent: navigator.userAgent,
        url: window.location.href,
        protocol: window.location.protocol,
        host: window.location.host,
        pathname: window.location.pathname,
        localStorage: !!window.localStorage,
        sessionStorage: !!window.sessionStorage,
        fetch: !!window.fetch,
        timestamp: new Date().toISOString()
      };
      
      log(`Sistema: ${JSON.stringify(info, null, 2)}`);
      updateStatus('systemInfo', '‚úÖ Informa√ß√µes coletadas - ver logs', 'success');
    }

    async function testAuthentication() {
      log('Testando autentica√ß√£o...');
      updateStatus('authInfo', 'Testando...', 'loading');
      
      try {
        // Verificar se h√° token no localStorage
        const token = localStorage.getItem('token');
        const user = localStorage.getItem('user');
        
        log(`Token presente: ${!!token}`);
        log(`User data presente: ${!!user}`);
        
        if (token) {
          log(`Token: ${token.substring(0, 20)}...`);
        }
        
        if (user) {
          const userData = JSON.parse(user);
          log(`User: ${JSON.stringify(userData, null, 2)}`);
        }
        
        if (!token) {
          throw new Error('Sem token de autentica√ß√£o');
        }
        
        updateStatus('authInfo', '‚úÖ Token encontrado - ver logs', 'success');
        
      } catch (error) {
        log(`Erro na autentica√ß√£o: ${error.message}`, 'error');
        updateStatus('authInfo', `‚ùå ${error.message}`, 'error');
      }
    }

    async function testNetlifyFunctions() {
      log('Testando fun√ß√µes Netlify...');
      updateStatus('functionsInfo', 'Testando...', 'loading');
      
      const functions = [
        'admin-users',
        'auth-me',
        'list-ocr'
      ];
      
      let results = [];
      
      for (const func of functions) {
        try {
          log(`Testando fun√ß√£o: ${func}`);
          
          const url = `/.netlify/functions/${func}`;
          log(`URL: ${url}`);
          
          const response = await fetch(url, {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('token') || 'no-token'}`
            }
          });
          
          log(`${func}: Status ${response.status}`);
          
          const responseText = await response.text();
          log(`${func}: Response: ${responseText.substring(0, 200)}...`);
          
          results.push(`${func}: ${response.status}`);
          
        } catch (error) {
          log(`${func}: ERRO - ${error.message}`, 'error');
          results.push(`${func}: ERRO`);
        }
      }
      
      updateStatus('functionsInfo', `Testado: ${results.join(', ')}`, 'success');
    }

    async function testAdminUsers() {
      log('Testando especificamente admin-users...');
      updateStatus('adminUsersInfo', 'Testando...', 'loading');
      
      try {
        const token = localStorage.getItem('token');
        if (!token) {
          throw new Error('Sem token de autentica√ß√£o');
        }
        
        log('Fazendo request para admin-users...');
        
        const response = await fetch('/.netlify/functions/admin-users', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });
        
        log(`Status: ${response.status}`);
        log(`Headers: ${JSON.stringify([...response.headers.entries()], null, 2)}`);
        
        const responseText = await response.text();
        log(`Response completa: ${responseText}`);
        
        if (response.ok) {
          const data = JSON.parse(responseText);
          log(`Dados parseados: ${JSON.stringify(data, null, 2)}`);
          
          if (data.success && data.users) {
            updateStatus('adminUsersInfo', `‚úÖ ${data.users.length} utilizadores encontrados`, 'success');
          } else {
            updateStatus('adminUsersInfo', `‚ùå Resposta inv√°lida: ${data.error || 'Sem dados'}`, 'error');
          }
        } else {
          updateStatus('adminUsersInfo', `‚ùå Erro HTTP ${response.status}: ${responseText}`, 'error');
        }
        
      } catch (error) {
        log(`Erro cr√≠tico: ${error.message}`, 'error');
        log(`Stack: ${error.stack}`, 'error');
        updateStatus('adminUsersInfo', `‚ùå ${error.message}`, 'error');
      }
    }

    // Inicializa√ß√£o
    document.addEventListener('DOMContentLoaded', function() {
      log('P√°gina de debug carregada');
      log('Clique nos bot√µes para executar os testes');
      
      // Auto-executar verifica√ß√£o do sistema
      setTimeout(checkSystemInfo, 1000);
    });
  </script>
</body>
</html>