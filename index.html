<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <title>EXPRESSGLASS • Receção material</title>
  <link rel="stylesheet" href="style.css?v=fix-col3-14px" />
  <style>
<style>
/* ===== EXPANDIR TABELA PARA LARGURA COMPLETA ===== */
.card {
  width: 98vw !important;
  max-width: none !important;
  margin: 16px 1vw !important;
}

table {
  width: 100% !important;
}

/* ===== FORÇAR TABELA DESKTOP GRANDE ===== */
@media (min-width: 769px) {
  .card {
    width: 98vw !important;
    max-width: none !important;
    margin: 16px 1vw !important;
  }
  
  .table-container {
    width: 100% !important;
    overflow-x: auto !important;
  }
  
  table {
    width: 100% !important;
    min-width: 1200px !important;
  }
  
  .desktop-only {
    display: block !important;
  }
}

/* ===== ESCONDER BOTÕES DESNECESSÁRIOS ===== */
#modernBtnNoEurocode,
#modernBtnCancel,
button[onclick*="noEurocode"],
button[onclick*="cancel"] {
  display: none !important;
}

.view-badge {
  display: none !important;
}

/* ===== FORÇAR TABELA LARGURA COMPLETA ===== */
.card {
  width: 98vw !important;
  max-width: none !important;
  margin: 16px 1vw !important;
}

.table-container {
  width: 100% !important;
}

table {
  width: 100% !important;
}

/* ===== BOTÃO SAIR DISCRETO ===== */
.header {
  flex-direction: column !important;
  align-items: center !important;
  gap: 15px !important;
}

#userInfo {
  position: fixed !important;
  top: 150px !important;
  right: 30px !important;
  background: none !important;
  border: none !important;
  padding: 0 !important;
  box-shadow: none !important;
  z-index: 9999 !important;
  width: auto !important;
  height: auto !important;
  display: block !important;
  visibility: visible !important;
  opacity: 1 !important;
}

#userInfo > div {
  background: none !important;
  padding: 0 !important;
  display: none !important;
}

#userName, #userEmail {
  display: none !important;
}

#logoutBtn {
  background: rgba(239, 68, 68, 0.9) !important;
  color: white !important;
  border: none !important;
  padding: 8px 12px !important;
  border-radius: 20px !important;
  font-size: 11px !important;
  font-weight: 600 !important;
  cursor: pointer !important;
  backdrop-filter: blur(10px) !important;
  box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3) !important;
  transition: all 0.3s ease !important;
  text-transform: uppercase !important;
  letter-spacing: 0.5px !important;
}

#logoutBtn:hover {
  background: rgba(220, 38, 38, 0.95) !important;
  transform: translateY(-1px) !important;
  box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4) !important;
}

/* ===== MOBILE STYLES ===== */
@media (max-width: 768px) {
  /* Esconder a versão mobile original */
  #mobileView.card.mobile-only {
    display: none !important;
  }

  /* Nova versão mobile moderna */
  .modern-mobile {
    display: flex !important;
    flex-direction: column;
    min-height: calc(100vh - 120px);
    padding: 0;
    background: transparent;
    border: none;
    box-shadow: none;
    margin: 0;
    width: 100%;
  }

  .modern-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 40px 20px 20px;
  }

  .modern-circle {
    width: 180px;
    height: 180px;
    background: white;
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    box-shadow: 0 20px 40px rgba(0,0,0,0.15);
    margin-bottom: 40px;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
  }

  .modern-circle:hover {
    transform: translateY(-5px);
    box-shadow: 0 25px 50px rgba(0,0,0,0.2);
  }

  .modern-circle:active {
    transform: translateY(-2px);
  }

  .modern-circle.processing {
    cursor: not-allowed;
    transform: none;
  }

  .modern-circle.processing:hover {
    transform: none;
  }

  .modern-camera-icon {
    font-size: 50px;
    margin-bottom: 8px;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
    transition: all 0.3s ease;
  }

  .modern-camera-label {
    font-size: 14px;
    font-weight: 600;
    color: #4a5568;
    letter-spacing: 0.5px;
    transition: all 0.3s ease;
  }

  .modern-circle.processing .modern-camera-label {
    color: #22c55e;
    font-weight: 700;
  }

  /* ANIMAÇÃO CORRIGIDA - Anel verde que roda ao redor do círculo */
  .modern-progress-ring {
    position: absolute;
    top: -8px;
    left: -8px;
    width: 196px;
    height: 196px;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .modern-circle.processing .modern-progress-ring {
    opacity: 1;
  }

  .modern-progress-ring circle {
    fill: none;
    stroke: #22c55e;
    stroke-width: 4;
    stroke-linecap: round;
    stroke-dasharray: 580;
    stroke-dashoffset: 580;
    transform-origin: center;
  }

  /* Animação de processamento - anel verde rotativo */
  .modern-circle.processing .modern-progress-ring circle {
    animation: modernProcessingRing 1.5s linear infinite;
    stroke-dasharray: 200 580;
    stroke-dashoffset: 0;
  }

  @keyframes modernProcessingRing {
    0% { 
      transform: rotate(0deg);
      stroke-dashoffset: 0;
    }
    50% {
      stroke-dashoffset: -100;
    }
    100% { 
      transform: rotate(360deg);
      stroke-dashoffset: -200;
    }
  }

  .modern-bottom-card {
    background: white;
    border-radius: 25px 25px 0 0;
    width: 100%;
    min-height: 280px;
    box-shadow: 0 -10px 30px rgba(0,0,0,0.1);
    padding: 25px 20px;
    margin-top: auto;
  }

  .modern-captures-header {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
    gap: 10px;
  }

  .modern-captures-title {
    font-size: 18px;
    font-weight: 700;
    color: #2d3748;
  }

  .modern-captures-icon {
    font-size: 20px;
  }

  .modern-capture-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .modern-capture-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 15px;
    background: #f7fafc;
    border-radius: 10px;
    border-left: 4px solid #22d3ee;
    transition: all 0.2s ease;
  }

  .modern-capture-item:hover {
    background: #edf2f7;
    transform: translateX(3px);
  }

  .modern-capture-code {
    font-weight: 600;
    color: #2d3748;
    font-size: 13px;
    letter-spacing: 0.3px;
  }

  .modern-capture-check {
    color: #22d3ee;
    font-size: 16px;
  }

  .modern-empty-state {
    text-align: center;
    padding: 30px 20px;
    color: #a0aec0;
  }

  .modern-empty-icon {
    font-size: 40px;
    margin-bottom: 12px;
    opacity: 0.5;
  }

  /* Botão de Entrada Manual */
  .modern-manual-btn {
    background: #16a34a;
    color: white;
    border: none;
    border-radius: 15px;
    padding: 12px 24px;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(22, 163, 74, 0.3);
    margin-top: 20px;
  }

  .modern-manual-btn:hover {
    background: #15803d;
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(22, 163, 74, 0.4);
  }

  .modern-manual-btn:active {
    transform: translateY(0);
  }

  .modern-manual-icon {
    font-size: 16px;
  }

  .modern-manual-label {
    font-size: 14px;
    font-weight: 600;
  }

  .modern-empty-text {
    font-size: 14px;
    font-weight: 500;
  }

  .modern-status {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(255,255,255,0.95);
    padding: 10px 18px;
    border-radius: 20px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    backdrop-filter: blur(10px);
    font-weight: 600;
    color: #2d3748;
    font-size: 14px;
    opacity: 0;
    transition: all 0.3s ease;
    z-index: 1000;
  }

  .modern-status.show {
    opacity: 1;
  }

  .modern-status.success {
    background: rgba(72, 187, 120, 0.95);
    color: white;
  }

  .modern-status.error {
    background: rgba(245, 101, 101, 0.95);
    color: white;
  }

  .modern-status.processing {
    background: rgba(34, 197, 94, 0.95);
    color: white;
  }

  /* Modal de Seleção de Eurocode */
  .modern-eurocode-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    padding: 20px;
  }

  .modern-eurocode-modal.show {
    display: flex;
  }

  .modern-modal-content {
    background: white;
    border-radius: 20px;
    width: 100%;
    max-width: 400px;
    max-height: 80vh;
    overflow: hidden;
    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    animation: modalSlideUp 0.3s ease;
  }

  @keyframes modalSlideUp {
    from {
      transform: translateY(50px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  .modern-modal-header {
    padding: 25px 25px 20px;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .modern-modal-title {
    font-size: 20px;
    font-weight: 700;
    color: #2d3748;
    margin: 0;
  }

  .modern-modal-icon {
    font-size: 24px;
  }

  .modern-modal-body {
    padding: 20px 25px;
    max-height: 50vh;
    overflow-y: auto;
  }

  .modern-ocr-section {
    margin-bottom: 25px;
  }

  .modern-ocr-label {
    font-size: 14px;
    font-weight: 600;
    color: #4a5568;
    margin-bottom: 8px;
    display: block;
  }

  .modern-ocr-text {
    background: #f7fafc;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 12px;
    font-size: 12px;
    line-height: 1.4;
    color: #2d3748;
    max-height: 100px;
    overflow-y: auto;
    white-space: pre-wrap;
    word-break: break-word;
  }

  .modern-eurocodes-section {
    margin-bottom: 20px;
  }

  .modern-eurocodes-label {
    font-size: 16px;
    font-weight: 600;
    color: #2d3748;
    margin-bottom: 15px;
    display: block;
  }

  .modern-eurocode-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .modern-eurocode-button {
    background: #3182ce;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 12px 16px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: left;
    letter-spacing: 0.5px;
  }

  .modern-eurocode-button:hover {
    background: #2c5aa0;
    transform: translateY(-1px);
  }

  .modern-eurocode-button:active {
    transform: translateY(0);
  }

  .modern-modal-footer {
    padding: 20px 25px 25px;
    border-top: 1px solid #e2e8f0;
    display: flex;
    gap: 12px;
  }

  .modern-modal-btn {
    flex: 1;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    border: none;
  }

  .modern-btn-secondary {
    background: #6b7280;
    color: white;
  }

  .modern-btn-secondary:hover {
    background: #4b5563;
  }

  .modern-btn-danger {
    background: #ef4444;
    color: white;
  }

  .modern-btn-danger:hover {
    background: #dc2626;
  }

  .modern-btn-primary {
    background: #16a34a;
    color: white;
  }

  .modern-btn-primary:hover {
    background: #15803d;
  }

  /* Campos do Modal de Entrada Manual */
  .modern-field {
    margin-bottom: 20px;
  }

  .modern-field-label {
    font-size: 14px;
    font-weight: 600;
    color: #4a5568;
    margin-bottom: 8px;
    display: block;
  }

  .modern-field-input,
  .modern-field-select {
    width: 100%;
    background: #f7fafc;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 12px;
    font-size: 14px;
    color: #2d3748;
    transition: all 0.2s ease;
    box-sizing: border-box;
  }

  .modern-field-input:focus,
  .modern-field-select:focus {
    outline: none;
    border-color: #16a34a;
    box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.1);
  }

  .modern-field-input::placeholder {
    color: #a0aec0;
  }
}

/* Desktop mantém-se igual - sem alterações */
@media (min-width: 769px) {
  .mobile-only {
    display: none !important;
  }
  
  .desktop-only {
    display: block !important;
  }
}
</style>

<script src="auth.js"></script>

</head>
<body>
  <header class="header">
    <div class="logo">
      <img src="logo.png" alt="EXPRESSGLASS" />
    </div>
    <h1>RECEÇÃO MATERIAL</h1>
    <div id="userInfo" class="user-info">
      <div>
        <span id="userName"></span>
        <span id="userEmail"></span>
      </div>
      <button id="logoutBtn">SAIR</button>
    </div>
  </header>

  <!-- MOBILE VIEW ORIGINAL -->
  <main id="mobileView" class="card mobile-only">
    <!-- Botão de ajuda -->
    <button class="help-btn" id="helpBtn" aria-label="Ajuda">?</button>
    
    <div class="mobile-cta">
      <div class="mode-grid" style="display:grid; grid-template-columns: 1fr; gap: 12px;">
        <button id="btnCamera" class="btn-square mode-btn selected" aria-label="Tirar foto (Eurocode)" style="width:100%;">
          <span class="emoji">📷</span>
          <span class="mode-label">Eurocode</span>
        </button>
        <button id="btnManualEntry" class="btn-square mode-btn" aria-label="Entrada manual" style="width:100%; background: #16a34a;">
          <span class="emoji">✏️</span>
          <span class="mode-label">Entrada manual</span>
        </button>
      </div>
    </div>

    <input id="cameraInput" type="file" accept="image/*" capture="environment" hidden />
    <div id="mobileStatus" class="status"></div>

    <!-- Histórico de Capturas -->
    <div id="mobileHistory" class="history-section">
      <h3 class="history-title">📋 Últimas Capturas</h3>
      <div id="mobileHistoryList" class="history-list">
        <p class="history-empty">Ainda não há Eurocodes guardados.</p>
      </div>
    </div>

    <footer class="footnote">
      <small>Feito por Marco Amorim</small>
    </footer>
  </main>

  <!-- NOVA MOBILE VIEW MODERNA -->
  <main class="modern-mobile mobile-only">
    <!-- Status Message -->
    <div id="modernStatus" class="modern-status"></div>

    <!-- Main Container -->
    <div class="modern-main">
      <!-- Central Circle -->
      <div class="modern-circle" id="modernCameraButton">
        <!-- Progress Ring -->
        <svg class="modern-progress-ring">
          <circle cx="98" cy="98" r="92"></circle>
        </svg>
        
        <!-- Camera Icon -->
        <div class="modern-camera-icon">📷</div>
        <div class="modern-camera-label">Eurocode</div>
      </div>
      
      <!-- Manual Entry Button -->
      <button id="modernManualEntry" class="modern-manual-btn">
        <span class="modern-manual-icon">✏️</span>
        <span class="modern-manual-label">Entrada manual</span>
      </button>
    </div>

    <!-- Bottom Card -->
    <div class="modern-bottom-card">
      <div class="modern-captures-header">
        <span class="modern-captures-icon">📋</span>
        <h2 class="modern-captures-title">Últimas Capturas</h2>
      </div>

      <div id="modernCapturesList" class="modern-capture-list">
        <!-- Will be populated by JavaScript -->
      </div>
    </div>
  </main>

  <!-- MODAL DE SELEÇÃO DE EUROCODE (MOBILE) -->
  <div id="modernEurocodeModal" class="modern-eurocode-modal">
    <div class="modern-modal-content">
      <div class="modern-modal-header">
        <span class="modern-modal-icon">🔍</span>
        <h3 class="modern-modal-title">Selecionar Eurocode</h3>
      </div>

      <div class="modern-modal-body">
        <!-- Só a lista de eurocodes -->
        <div class="modern-eurocodes-section">
          <label class="modern-eurocodes-label">Eurocodes encontrados: Clique no correto</label>
          <div id="modernEurocodeList" class="modern-eurocode-list"></div>
        </div>
      </div>

      <div class="modern-modal-footer">
        <button id="modernBtnNoEurocode" class="modern-modal-btn modern-btn-secondary">Sem Eurocode</button>
        <button id="modernBtnCancel" class="modern-modal-btn modern-btn-danger">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- MODAL DE ENTRADA MANUAL (MOBILE) -->
  <div id="manualEntryModal" class="modern-eurocode-modal">
    <div class="modern-modal-content">
      <div class="modern-modal-header">
        <span class="modern-modal-icon">✏️</span>
        <h3 class="modern-modal-title">Entrada Manual</h3>
      </div>

      <div class="modern-modal-body">
        <div class="modern-field">
          <label class="modern-field-label">Eurocode</label>
          <input id="manualEurocode" type="text" class="modern-field-input" placeholder="Ex: 4912AGNCM1H" />
        </div>
        
        <div class="modern-field">
          <label class="modern-field-label">Marca do Carro</label>
          <select id="manualCarBrand" class="modern-field-select">
            <option value="">Selecionar marca...</option>
            <option value="BMW">BMW</option>
            <option value="Mercedes-Benz">Mercedes-Benz</option>
            <option value="Audi">Audi</option>
            <option value="Volkswagen">Volkswagen</option>
            <option value="Seat">Seat</option>
            <option value="Škoda">Škoda</option>
            <option value="Opel">Opel</option>
            <option value="Peugeot">Peugeot</option>
            <option value="Citroën">Citroën</option>
            <option value="Renault">Renault</option>
            <option value="Dacia">Dacia</option>
            <option value="Fiat">Fiat</option>
            <option value="Alfa Romeo">Alfa Romeo</option>
            <option value="Ford">Ford</option>
            <option value="Toyota">Toyota</option>
            <option value="Honda">Honda</option>
            <option value="Nissan">Nissan</option>
            <option value="Mazda">Mazda</option>
            <option value="Hyundai">Hyundai</option>
            <option value="Kia">Kia</option>
            <option value="Volvo">Volvo</option>
            <option value="Tesla">Tesla</option>
            <option value="MAN">MAN</option>
            <option value="Scania">Scania</option>
            <option value="DAF">DAF</option>
          </select>
        </div>
      </div>

      <div class="modern-modal-footer">
        <button id="manualEntryCancel" class="modern-modal-btn modern-btn-secondary">Cancelar</button>
        <button id="manualEntrySave" class="modern-modal-btn modern-btn-primary">Guardar</button>
      </div>
    </div>
  </div>

  <!-- DESKTOP VIEW (mantém-se 100% igual ao original) -->
  <section id="desktopView" class="card desktop-only">
    <!-- Botão de ajuda -->
    <button class="help-btn" id="helpBtnDesktop" aria-label="Ajuda">?</button>
    
    <div class="toolbar">
      <button id="btnUpload" class="btn" onclick="document.getElementById('fileInput').click()">📁 Carregar imagem</button>
      <input id="fileInput" type="file" accept="image/*,.pdf" hidden
       onchange="if(this.files&&this.files[0]){ window.processImage && window.processImage(this.files[0]); }" />
      <button id="btnExport" class="btn" onclick="window.openExportModal && window.openExportModal()">📊 Exportar Excel</button>
      <button id="btnPrint" class="btn" onclick="openPrintModal()">🖨️ Imprimir</button>
      <button id="btnClear" class="btn danger" onclick="window.clearTable && window.clearTable()">🗑️ Limpar Tabela</button>
    </div>

    <div class="table-wrap">
      <table id="resultsTable">
        <thead>
          <tr>
            <th style="width:60px">#</th>
            <th style="width:220px">Data/Hora</th>
            <th style="width:120px">Tipo</th>
            <th style="width:160px">Veículo</th>
            <th style="width:180px">Eurocode</th>
            <th style="width:160px">Marca</th>
            <th style="width:120px">Matrícula</th>
            <th style="width:100px">SM/LOJA</th>
            <th style="width:200px">OBS</th>
            <th style="width:140px">Ações</th>
          </tr>
        </thead>
        <tbody id="resultsBody">
          <!-- Dados serão inseridos aqui -->
        </tbody>
      </table>
    </div>

    <div id="desktopStatus" class="status"></div>

    <!-- Pesquisa -->
    <div class="search-container">
      <input id="searchInput" type="text" placeholder="Procurar Eurocode..." />
      <button id="clearSearch" class="clear-search" title="Limpar pesquisa">✕</button>
    </div>
  </section>

  <!-- Scripts para interface moderna mobile -->
  <script>
    // Variáveis globais para interface moderna
    let modernStatus, modernCameraButton, modernCapturesList, modernEurocodeModal, modernEurocodeList;
    let modernOcrText, modernBtnNoEurocode, modernBtnCancel;
    let isProcessing = false;

    // Inicializar elementos
    document.addEventListener('DOMContentLoaded', () => {
      modernStatus = document.getElementById('modernStatus');
      modernCameraButton = document.getElementById('modernCameraButton');
      modernCapturesList = document.getElementById('modernCapturesList');
      modernEurocodeModal = document.getElementById('modernEurocodeModal');
      modernEurocodeList = document.getElementById('modernEurocodeList');
      modernOcrText = document.getElementById('modernOcrText');
      modernBtnNoEurocode = document.getElementById('modernBtnNoEurocode');
      modernBtnCancel = document.getElementById('modernBtnCancel');
    });

    // Mostrar status moderno
    function showModernStatus(message, type = 'info') {
      if (!modernStatus) return;
      
      modernStatus.textContent = message;
      modernStatus.className = `modern-status show ${type}`;
      
      setTimeout(() => {
        modernStatus.classList.remove('show');
      }, 3000);
    }

    // Parar processamento
    function stopProcessing() {
      isProcessing = false;
      if (modernCameraButton) {
        modernCameraButton.classList.remove('processing');
      }
    }

    // Iniciar processamento
    function startProcessing() {
      isProcessing = true;
      if (modernCameraButton) {
        modernCameraButton.classList.add('processing');
      }
    }

    // Renderizar capturas modernas
    async function renderModernCaptures() {
      if (!modernCapturesList) return;

      try {
        const response = await fetch('/.netlify/functions/get-rows');
        if (!response.ok) throw new Error('Erro na API');
        
        const data = await response.json();
        const captures = data.slice(0, 10); // Últimas 10

        if (captures.length === 0) {
          modernCapturesList.innerHTML = `
            <div class="modern-empty-state">
              <div class="modern-empty-icon">📋</div>
              <div class="modern-empty-text">Ainda não há capturas</div>
            </div>
          `;
          return;
        }

        modernCapturesList.innerHTML = captures.map(capture => `
          <div class="modern-capture-item">
            <div class="modern-capture-code">${capture.eurocode || 'Sem Eurocode'}</div>
            <div class="modern-capture-check">✓</div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Erro ao carregar capturas:', error);
        modernCapturesList.innerHTML = `
          <div class="modern-empty-state">
            <div class="modern-empty-icon">⚠️</div>
            <div class="modern-empty-text">Erro ao carregar</div>
          </div>
        `;
      }
    }

    // Mostrar modal de eurocode moderno
    function showModernEurocodeModal(ocrText, eurocodes) {
      if (!modernEurocodeModal || !modernEurocodeList) return;

      // Parar animação
      stopProcessing();

      // Preencher lista de eurocodes
      if (eurocodes && eurocodes.length > 0) {
        modernEurocodeList.innerHTML = eurocodes.map(code => `
          <button class="modern-eurocode-button" onclick="selectModernEurocode('${code}', '${ocrText}')">
            ${code}
          </button>
        `).join('');
      } else {
        modernEurocodeList.innerHTML = '<p style="color: #a0aec0; text-align: center; padding: 20px;">Nenhum Eurocode encontrado</p>';
      }

      // Mostrar modal
      modernEurocodeModal.style.display = 'flex';
      modernEurocodeModal.classList.add('show');
    }

    // Esconder modal de eurocode moderno
    function hideModernEurocodeModal() {
      if (modernEurocodeModal) {
        modernEurocodeModal.style.display = 'none';
        modernEurocodeModal.classList.remove('show');
      }
    }

    // Selecionar eurocode moderno
    async function selectModernEurocode(eurocode, ocrText) {
      hideModernEurocodeModal();
      showModernStatus('A guardar...', 'processing');

      try {
        // Usar a função original para salvar
        if (window.saveValidatedResult) {
          await window.saveValidatedResult(ocrText, eurocode);
          showModernStatus('Guardado com sucesso!', 'success');
          setTimeout(renderModernCaptures, 500);
        }
      } catch (error) {
        console.error('Erro ao guardar:', error);
        showModernStatus('Erro ao guardar', 'error');
      }
    }

    // Interceptar eventos de sucesso
    function interceptSuccessEvents() {
      // Observar mudanças na tabela para detectar novos registos
      const tbody = document.getElementById('resultsBody');
      if (tbody) {
        let lastRowCount = tbody.children.length;
        
        new MutationObserver(() => {
          const currentRowCount = tbody.children.length;
          if (currentRowCount > lastRowCount) {
            // Nova linha adicionada
            showModernStatus('Guardado com sucesso!', 'success');
            stopProcessing();
            setTimeout(renderModernCaptures, 500);
          }
          lastRowCount = currentRowCount;
        }).observe(tbody, { childList: true });
      }
    }

    // Event listener para câmara moderna
    if (modernCameraButton) {
      modernCameraButton.addEventListener('click', () => {
        if (isProcessing) return;
        
        const fileInput = document.getElementById('cameraInput');
        if (fileInput) {
          fileInput.click();
        }
      });
    }

    // Event listener para input de câmara
    const cameraInput = document.getElementById('cameraInput');
    if (cameraInput) {
      cameraInput.addEventListener('change', (e) => {
        if (e.target.files && e.target.files[0]) {
          startProcessing();
          showModernStatus('A processar imagem...', 'processing');
          
          if (window.processImage) {
            window.processImage(e.target.files[0]);
          }
        }
      });
    }

    // Interceptar modal clássico
    function interceptClassicModal() {
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
            const modal = mutation.target;
            if (modal.id === 'eurocodeModal' && modal.style.display === 'flex') {
              // Modal clássico apareceu, extrair dados
              const ocrTextEl = modal.querySelector('#ocrText');
              const eurocodeListEl = modal.querySelector('#eurocodeList');
              
              if (ocrTextEl && eurocodeListEl) {
                const ocrText = ocrTextEl.textContent || ocrTextEl.value || '';
                const eurocodes = Array.from(eurocodeListEl.querySelectorAll('button')).map(btn => 
                  btn.textContent.trim()
                ).filter(Boolean);
                
                // Esconder modal clássico
                modal.style.display = 'none';
                modal.classList.remove('show');
                
                // Mostrar modal moderno (que já para a animação)
                showModernEurocodeModal(ocrText, eurocodes);
              }
            }
          }
        });
      });

      observer.observe(document.body, {
        childList: true,
        subtree: true,
        attributes: true,
        attributeFilter: ['style', 'class']
      });
    }

    // Interceptar erros para parar a animação
    function interceptErrors() {
      // Observar mensagens de erro
      const statusElements = document.querySelectorAll('[id*="status"], [class*="status"]');
      statusElements.forEach(statusEl => {
        if (statusEl && statusEl !== modernStatus) {
          new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
              if (mutation.type === 'childList' || mutation.type === 'characterData') {
                const text = statusEl.textContent || statusEl.innerText || '';
                if (text.toLowerCase().includes('erro') || text.toLowerCase().includes('error')) {
                  console.log('Erro detectado:', text);
                  stopProcessing();
                  showModernStatus('Erro ao processar imagem', 'error');
                }
              }
            });
          }).observe(statusEl, { childList: true, subtree: true, characterData: true });
        }
      });
    }

    // Modal button handlers
    if (modernBtnNoEurocode) {
      modernBtnNoEurocode.addEventListener('click', () => {
        hideModernEurocodeModal();
        showModernStatus('Guardado sem Eurocode', 'success');
        
        // CORREÇÃO: Garantir que para a animação
        stopProcessing();
        
        // Usar a função original para guardar sem eurocode
        if (window.saveWithoutEurocode) {
          const ocrText = modernOcrText ? modernOcrText.textContent : '';
          window.saveWithoutEurocode(ocrText);
        }
        
        // Atualizar lista de capturas
        setTimeout(renderModernCaptures, 500);
      });
    }

    if (modernBtnCancel) {
      modernBtnCancel.addEventListener('click', () => {
        hideModernEurocodeModal();
        showModernStatus('Operação cancelada', 'error');
        // CORREÇÃO: Para a animação quando cancela
        stopProcessing();
      });
    }

    // Close modal when clicking outside
    if (modernEurocodeModal) {
      modernEurocodeModal.addEventListener('click', (e) => {
        if (e.target === modernEurocodeModal) {
          hideModernEurocodeModal();
          showModernStatus('Operação cancelada', 'error');
          // CORREÇÃO: Para a animação quando fecha
          stopProcessing();
        }
      });
    }

    // Initialize modern interface
    document.addEventListener('DOMContentLoaded', () => {
      console.log('Interface moderna inicializada');
      renderModernCaptures();
      interceptClassicModal();
      interceptErrors();
      interceptSuccessEvents(); // CORREÇÃO: Adicionar interceptação de sucessos
      
      // Atualizar lista periodicamente
      setInterval(renderModernCaptures, 5000);
    });

    // Render initial captures
    renderModernCaptures();
    interceptClassicModal();
    interceptErrors();
    interceptSuccessEvents(); // CORREÇÃO: Adicionar interceptação de sucessos
  </script>

  <!-- Scripts originais mantidos -->
  <script>
  (function(){
    const listEl = document.getElementById('mobileHistoryList');
    if (!listEl) return;

    async function fetchRowsFromAPI(){
      try {
        const resp = await fetch('/.netlify/functions/get-rows');
        if (!resp.ok) return null;
        return await resp.json();
      } catch {
        return null;
      }
    }

    function pickEuro(row){
      const c = (row?.eurocode || '').trim();
      return c || null;
    }

    function scrapeEurocodesFromTable(limit=50){
      const tbody = document.getElementById('resultsBody');
      if(!tbody) return [];
      const rows = Array.from(tbody.querySelectorAll('tr'));
      const out = [];
      for (const tr of rows){
        const td = tr.querySelector('td:nth-child(4)');
        const raw = (td?.innerText || td?.textContent || '').trim();
        const code = raw.split(/\s+/)[0];
        if (code) out.push(code);
        if (out.length >= limit) break;
      }
      return out;
    }

    function renderList(codes){
      if (!listEl) return;
      if (!codes || !codes.length){
        listEl.innerHTML = '<p class="history-empty">Ainda não há Eurocodes guardados.</p>';
        return;
      }
      const ul = document.createElement('ul');
      ul.style.listStyle = 'none';
      ul.style.margin = '0';
      ul.style.padding = '0';
      codes.forEach(code => {
        const li = document.createElement('li');
        li.textContent = code;
        li.style.textAlign = 'left';
        li.style.padding = '10px 12px';
        li.style.borderBottom = '1px solid rgba(255,255,255,0.08)';
        li.style.fontWeight = '700';
        li.style.letterSpacing = '.3px';
        ul.appendChild(li);
      });
      listEl.innerHTML = '';
      listEl.appendChild(ul);
    }

    async function refresh(){
      const apiRows = await fetchRowsFromAPI();
      if (apiRows){
        const codes = apiRows.map(pickEuro).filter(Boolean);
        renderList([...new Set(codes)].slice(0,50));
        return;
      }
      const codes = scrapeEurocodesFromTable();
      renderList([...new Set(codes)].slice(0,50));
    }

    refresh();

    const tbody = document.getElementById('resultsBody');
    if (tbody){
      new MutationObserver(refresh)
        .observe(tbody, { childList:true, subtree:true, characterData:true });
    }

    document.addEventListener('click', (e) => {
      const t = e.target;
      const txt = (t?.textContent || '').toLowerCase();
      const isValidate = txt.includes('valid') || t?.dataset?.action === 'validate';
      if (isValidate) setTimeout(refresh, 500);
    });

    setInterval(refresh, 10000);
  })();
  </script>

  <script>
  (function(){
    const tbody = document.getElementById('resultsBody');
    function fixCol3(){
      if(!tbody) return;
      const rows = tbody.querySelectorAll('tr');
      rows.forEach(row => {
        const col3 = row.querySelector('td:nth-child(3)');
        if(col3){
          col3.style.fontSize = '14px';
          col3.style.fontWeight = 'bold';
        }
      });
    }
    if(tbody){
      new MutationObserver(fixCol3).observe(tbody, {childList:true, subtree:true});
      fixCol3();
    }
  })();
  </script>

  <script src="app.js"></script>

  <!-- ===== MODAL EXPORTAÇÃO PARA EXCEL ===== -->
  <div id="exportModal" class="export-modal" style="display:none;">
    <div class="export-modal-content">
      <div class="export-modal-header">
        <h3>📤 Exportar para Excel</h3>
        <button id="exportModalClose" class="export-close" title="Fechar">×</button>
      </div>
      <div class="export-modal-body">
        <!-- Botões de filtro rápido -->
        <div class="export-field">
          <label>Período de exportação</label>
          <div class="export-quick-buttons">
            <button id="exportToday" class="export-quick-btn active" data-period="today">Hoje</button>
            <button id="exportWeek" class="export-quick-btn" data-period="week">Esta Semana</button>
            <button id="exportAll" class="export-quick-btn" data-period="all">Tudo</button>
          </div>
        </div>
        
        <!-- Campos de data (preenchidos automaticamente) -->
        <div class="export-field">
          <label for="exportStart">Data início</label>
          <input id="exportStart" type="date" />
        </div>
        <div class="export-field">
          <label for="exportEnd">Data fim</label>
          <input id="exportEnd" type="date" />
        </div>
        
        <div class="export-field inline">
          <label class="inline-label">
            <input id="exportUseSearch" type="checkbox" checked />
            Usar também o filtro de pesquisa atual (Eurocode)
          </label>
        </div>
      </div>
      <div class="export-modal-footer">
        <button id="exportModalCancel" class="btn-secondary">Cancelar</button>
        <button id="exportModalConfirm" class="btn-primary">Exportar</button>
      </div>
    </div>
  </div>

  <style>
    .export-modal{ position: fixed; inset:0; background: rgba(0,0,0,.7); display:none; align-items:center; justify-content:center; z-index:1200; backdrop-filter: blur(6px); padding:16px; }
    .export-modal.show{ display:flex }
    .export-modal-content{ width:100%; max-width:520px; background: var(--card,#0f172a); color:var(--text,#e5e7eb); border:1px solid var(--cardBorder,#1f2937); border-radius:16px; box-shadow: var(--shadowLarge,0 20px 40px rgba(0,0,0,.35)); display:flex; flex-direction:column; overflow:hidden; animation: modalSlideIn .25s ease; }
    @keyframes modalSlideIn{ from{ transform: translateY(10px); opacity:.6 } to{ transform:none; opacity:1 } }
    .export-modal-header{ display:flex; align-items:center; justify-content:space-between; padding:16px 20px; border-bottom:1px solid var(--cardBorder,#1f2937); }
    .export-modal-header h3{ margin:0; font-size:18px; color: var(--accent,#22d3ee) }
    .export-close{ background:none; border:0; color: var(--muted,#a3aed0); font-size:24px; cursor:pointer; line-height:1; border-radius:8px; padding:2px 6px; }
    .export-close:hover{ color:#fff; background: rgba(255,255,255,.08) }
    .export-modal-body{ padding:16px 20px; display:grid; gap:12px }
    .export-field{ display:grid; gap:6px }
    .export-field.inline{ display:flex; align-items:center; }
    .export-field label{ font-weight:600; font-size:14px; color: var(--muted,#a3aed0) }
    .export-field input[type="date"]{ background: rgba(255,255,255,.06); border:1px solid var(--cardBorder,#1f2937); color: var(--text,#e5e7eb); border-radius:10px; padding:10px 12px; font-size:14px; }
    .export-quick-buttons{ display:flex; gap:8px; margin-top:8px; }
    .export-quick-btn{ background: rgba(255,255,255,.08); color: var(--muted,#a3aed0); border:1px solid var(--cardBorder,#1f2937); padding:8px 16px; border-radius:8px; cursor:pointer; font-size:13px; font-weight:600; transition: all 0.2s ease; }
    .export-quick-btn:hover{ background: rgba(255,255,255,.12); color: var(--text,#e5e7eb); }
    .export-quick-btn.active{ background: var(--accent,#22d3ee); color: #0f172a; border-color: var(--accent,#22d3ee); }
    .export-modal-footer{ display:flex; gap:10px; justify-content:flex-end; padding:16px 20px; border-top:1px solid var(--cardBorder,#1f2937); }
    .btn-secondary{ background:#6b7280; color:white; border:none; padding:10px 16px; border-radius:10px; cursor:pointer; }
    .btn-primary{ background:#06b6d4; color:white; border:none; padding:10px 16px; border-radius:10px; cursor:pointer; font-weight:700; }
    .btn-primary:hover{ filter:brightness(1.05); }
    
    /* Modal de Edição de Registo */
    .edit-record-modal{ position: fixed; inset:0; background: rgba(0,0,0,.7); display:none; align-items:center; justify-content:center; z-index:1300; backdrop-filter: blur(6px); padding:16px; }
    .edit-record-modal.show{ display:flex }
    .edit-record-content{ width:100%; max-width:420px; background: var(--card,#0f172a); color:var(--text,#e5e7eb); border:1px solid var(--cardBorder,#1f2937); border-radius:16px; box-shadow: var(--shadowLarge,0 20px 40px rgba(0,0,0,.35)); display:flex; flex-direction:column; overflow:hidden; }
    .edit-record-header{ display:flex; align-items:center; justify-content:space-between; padding:16px 20px; border-bottom:1px solid var(--cardBorder,#1f2937); }
    .edit-record-header h3{ margin:0; font-size:18px; color: var(--accent,#22d3ee) }
    .edit-record-close{ background:none; border:0; color: var(--muted,#a3aed0); font-size:24px; cursor:pointer; line-height:1; border-radius:8px; padding:2px 6px; }
    .edit-record-close:hover{ color:#fff; background: rgba(255,255,255,.08) }
    .edit-record-body{ padding:16px 20px; display:grid; gap:16px }
    .edit-record-field{ display:grid; gap:8px }
    .edit-record-field label{ font-weight:600; font-size:14px; color: var(--muted,#a3aed0) }
    .edit-record-select{ background: rgba(255,255,255,.06); border:1px solid var(--cardBorder,#1f2937); color: var(--text,#e5e7eb); border-radius:10px; padding:10px 12px; font-size:14px; }
    .edit-record-textarea{ background: rgba(255,255,255,.06); border:1px solid var(--cardBorder,#1f2937); color: var(--text,#e5e7eb); border-radius:10px; padding:10px 12px; font-size:14px; min-height:80px; resize:vertical; font-family: inherit; }
    .edit-record-footer{ display:flex; gap:10px; justify-content:flex-end; padding:16px 20px; border-top:1px solid var(--cardBorder,#1f2937); }
  </style>

</body>
</html>
