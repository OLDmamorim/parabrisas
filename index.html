<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <title>EXPRESSGLASS • Receção material</title>
  <link rel="stylesheet" href="style.css?v=marca-col-acoes-icons" />
  <style>
    /* LOGO no header */
    .brand .title, .brand .subtitle { display:none }
    .brand { width:100%; padding:0; position:relative }
    .logo-container{
      background:#fff; border-radius:15px; padding:15px 20px; margin:0;
      box-shadow:0 4px 15px rgba(0,0,0,0.1); display:flex; align-items:center; justify-content:center
    }
    .logo{ max-width:100%; height:auto; max-height:60px }
    .subtitle-new{ color:rgba(255,255,255,.9); font-size:16px; font-weight:400; margin:12px 20px 0; text-align:center }
    .view-badge{ display:none !important }

    /* Input invisível que cobre o círculo (abre a câmara) */
    .camera-picker{
      position:absolute; inset:0; width:100%; height:100%;
      opacity:0; cursor:pointer; -webkit-appearance:none; appearance:none;
    }

    @media (max-width:768px){
      .logo{ max-height:50px }
      .subtitle-new{ font-size:14px }
    }
  </style>
</head>
<body>
  <!-- HEADER -->
  <header class="header">
    <div class="brand">
      <div class="logo-container">
        <img src="expressglass-logo.png" class="logo" alt="ExpressGlass - Vidros para Viaturas" />
      </div>
      <h1 class="title">EXPRESSGLASS</h1>
      <p class="subtitle">Receção material</p>
      <p class="subtitle-new">Receção material</p>
    </div>
    <div class="view-badge" id="viewBadge">Mobile</div>
  </header>

  <!-- MOBILE (clássico – mantido para compatibilidade) -->
  <main id="mobileView" class="card mobile-only">
    <button class="help-btn" id="helpBtn" aria-label="Ajuda">?</button>
    <div class="mobile-cta">
      <div class="mode-grid" style="display:grid; grid-template-columns:1fr; gap:12px;">
        <button id="btnCamera" class="btn-square mode-btn selected" aria-label="Tirar foto (Eurocode)" style="width:100%;">
          <span class="emoji">📷</span>
          <span class="mode-label">Eurocode</span>
        </button>
      </div>
    </div>
    <input id="cameraInput" type="file" accept="image/*" capture="environment" hidden />
    <div id="mobileStatus" class="status"></div>

    <div id="mobileHistory" class="history-section">
      <h3 class="history-title">📋 Últimas Capturas</h3>
      <div id="mobileHistoryList" class="history-list">
        <p class="history-empty">Ainda não há Eurocodes guardados.</p>
      </div>
    </div>

    <footer class="footnote"><small>Feito por Marco Amorim</small></footer>
  </main>

  <!-- MOBILE MODERNO -->
  <main class="modern-mobile mobile-only">
    <div id="modernStatus" class="modern-status"></div>
    <div class="modern-main" style="display:flex; flex-direction:column; align-items:center; padding:40px 20px 20px;">
      <div class="modern-circle" id="modernCircle" style="position:relative;">
        <svg class="modern-progress-ring"><circle cx="98" cy="98" r="92"></circle></svg>
        <div class="modern-camera-icon">📷</div>
        <div class="modern-camera-label">Eurocode</div>
        <!-- Input real a cobrir o círculo -->
        <input id="cameraPicker" class="camera-picker" type="file" accept="image/*" capture="environment" />
      </div>
    </div>
    <div class="modern-bottom-card">
      <div class="modern-captures-header">
        <span class="modern-captures-icon">📋</span>
        <h2 class="modern-captures-title">Últimas Capturas</h2>
      </div>
      <div id="modernCapturesList" class="modern-capture-list"></div>
    </div>
  </main>

  <!-- MODAL SELEÇÃO EUROCODE (mantido) -->
  <div id="modernEurocodeModal" class="modern-eurocode-modal">
    <div class="modern-modal-content">
      <div class="modern-modal-header">
        <span class="modern-modal-icon">🔍</span>
        <h3 class="modern-modal-title">Selecionar Eurocode</h3>
      </div>
      <div class="modern-modal-body">
        <div class="modern-ocr-section">
          <label class="modern-ocr-label">Texto lido:</label>
          <div id="modernOcrText" class="modern-ocr-text"></div>
        </div>
        <div class="modern-eurocodes-section">
          <label class="modern-eurocodes-label">Eurocodes encontrados: Clique no correto</label>
          <div id="modernEurocodeList" class="modern-eurocode-list"></div>
        </div>
      </div>
      <div class="modern-modal-footer">
        <button id="modernBtnNoEurocode" class="modern-modal-btn modern-btn-secondary">Sem Eurocode</button>
        <button id="modernBtnCancel" class="modern-modal-btn modern-btn-danger">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- DESKTOP -->
  <section id="desktopView" class="card desktop-only">
    <button class="help-btn" id="helpBtnDesktop" aria-label="Ajuda">?</button>

    <div class="toolbar">
      <button id="btnUpload" class="btn">📁 Carregar imagem</button>
      <input id="fileInput" type="file" accept="image/*,.pdf" hidden />
      <button id="btnExport" class="btn">📊 Exportar CSV</button>
      <button id="btnClear" class="btn danger">🗑️ Limpar Tabela</button>
    </div>

    <div class="table-wrap">
      <table id="resultsTable">
        <thead>
          <tr>
            <th style="width:60px">#</th>
            <th style="width:220px">Data/Hora</th>
            <th style="width:auto">Texto lido (Eurocode)</th>
            <th style="width:160px">Marca</th>
            <th style="width:180px">Eurocode</th>
            <th style="width:140px">Ações</th>
          </tr>
        </thead>
        <tbody id="resultsBody"></tbody>
      </table>
    </div>

    <div id="desktopStatus" class="status"></div>
  </section>

  <!-- MODAL DE AJUDA -->
  <div id="helpModal" class="help-modal">
    <div class="help-content">
      <button class="help-close" id="helpClose">&times;</button>
      <h3>💡 Como usar</h3>
      <p><strong>📷 Captura:</strong> Toca no círculo e tira foto da etiqueta.</p>
      <p><strong>📋 Texto:</strong> O sistema lê automaticamente.</p>
      <p><strong>💾 Dados:</strong> Ficam guardados na base de dados.</p>
      <p><strong>📊 Exportar:</strong> Exporta para CSV quando quiseres.</p>
    </div>
  </div>

  <!-- MODAL DE EDIÇÃO OCR -->
  <div id="editOcrModal" class="edit-ocr-modal">
    <div class="edit-ocr-content">
      <div class="edit-ocr-header">
        <h3>✏️ Editar texto lido (OCR)</h3>
        <button class="edit-ocr-close" id="editOcrClose">&times;</button>
      </div>
      <div class="edit-ocr-body">
        <textarea id="editOcrTextarea" class="edit-ocr-textarea" placeholder="Texto do OCR..."></textarea>
      </div>
      <div class="edit-ocr-footer">
        <button id="editOcrCancel" class="btn btn-secondary">Cancelar</button>
        <button id="editOcrSave" class="btn btn-primary">Guardar</button>
      </div>
    </div>
  </div>

  <!-- TOAST -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- App -->
  <script src="app.js?v=marca-col-camera-overlay"></script>

  <!-- Script MOBILE MODERNO (mínimo necessário) -->
  <script>
    const modernStatus = document.getElementById('modernStatus');
    const modernEurocodeModal = document.getElementById('modernEurocodeModal');
    const modernOcrText = document.getElementById('modernOcrText');
    const modernEurocodeList = document.getElementById('modernEurocodeList');
    const modernBtnNoEurocode = document.getElementById('modernBtnNoEurocode');
    const modernBtnCancel = document.getElementById('modernBtnCancel');
    const modernCapturesList = document.getElementById('modernCapturesList');
    const cameraPicker = document.getElementById('cameraPicker');

    let isProcessing = false;

    function showModernStatus(message, type = '') {
      if (!modernStatus) return;
      modernStatus.textContent = message;
      modernStatus.className = `modern-status show ${type}`;
      setTimeout(() => { modernStatus.className = 'modern-status'; }, 3000);
    }
    function startProcessing(){
      if (isProcessing) return;
      isProcessing = true;
      const circle = document.getElementById('modernCircle');
      if (circle) circle.classList.add('processing');
      showModernStatus('A processar imagem...', 'processing');
    }
    function stopProcessing(){
      if (!isProcessing) return;
      isProcessing = false;
      const circle = document.getElementById('modernCircle');
      if (circle) circle.classList.remove('processing');
    }
    window.stopProcessing = stopProcessing;

    function renderModernCaptures(){
      const tbody = document.getElementById('resultsBody');
      if (!tbody) return;
      const rows = Array.from(tbody.querySelectorAll('tr'));
      const captures = [];
      for (const tr of rows){
        const td = tr.querySelector('td:nth-child(5)'); // 5ª é Eurocode
        const code = td ? (td.textContent || '').trim().split(/\s+/)[0] : '';
        if (code) captures.push(code);
        if (captures.length>=5) break;
      }
      modernCapturesList.innerHTML = captures.length
        ? captures.map(c=>`<div class="modern-capture-item"><span class="modern-capture-code">${c}</span><span class="modern-capture-check">✓</span></div>`).join('')
        : `<div class="modern-empty-state"><div class="modern-empty-icon">📷</div><div class="modern-empty-text">Ainda não há capturas</div></div>`;
    }

    // O input real dispara o fluxo
    if (cameraPicker){
      cameraPicker.addEventListener('change', (e)=>{
        const f = e.target.files && e.target.files[0];
        if (!f){ stopProcessing(); showModernStatus('Operação cancelada', 'error'); return; }
        startProcessing();
        if (window.processImage){
          window.processImage(f).finally(()=>{ stopProcessing(); renderModernCaptures(); e.target.value=''; });
        }else{
          stopProcessing(); showModernStatus('Erro: função processImage não encontrada', 'error');
        }
      });
    }

    // Modal Eurocode (se quiseres usar no futuro)
    function showModernEurocodeModal(ocrText, eurocodes){
      stopProcessing();
      if (!modernEurocodeModal) return;
      if (modernOcrText) modernOcrText.textContent = ocrText || '';
      modernEurocodeList.innerHTML = (eurocodes || []).map(c => `<button class="modern-eurocode-button" data-eurocode="${c}">${c}</button>`).join('');
      modernEurocodeList.querySelectorAll('.modern-eurocode-button').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const code = btn.dataset.eurocode;
          modernEurocodeModal.classList.remove('show');
          showModernStatus(`Eurocode ${code} selecionado!`, 'success');
          if (window.saveEurocode) window.saveEurocode(code, ocrText || '');
          setTimeout(renderModernCaptures, 500);
        });
      });
      modernEurocodeModal.classList.add('show');
    }
    if (modernBtnNoEurocode){
      modernBtnNoEurocode.addEventListener('click', ()=>{
        modernEurocodeModal.classList.remove('show');
        showModernStatus('Guardado sem Eurocode', 'success');
        if (window.saveWithoutEurocode) window.saveWithoutEurocode(modernOcrText ? modernOcrText.textContent : '');
        setTimeout(renderModernCaptures, 500);
      });
    }
    if (modernBtnCancel){
      modernBtnCancel.addEventListener('click', ()=>{
        modernEurocodeModal.classList.remove('show');
        stopProcessing(); showModernStatus('Operação cancelada', 'error');
      });
    }

    document.addEventListener('DOMContentLoaded', renderModernCaptures);
    setInterval(renderModernCaptures, 5000);
  </script>
</body>
</html>